name: Fix Release State

on:
    workflow_dispatch:
        inputs:
            tag:
                description: "Tag to fix (e.g., v0.0.6)"
                required: true
                default: "v0.0.6"

permissions:
    contents: write
    issues: write
    pull-requests: write

jobs:
    fix:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "lts/*"

            - name: Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: latest

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Generate changelog
              id: changelog
              run: |
                  CURRENT_TAG=${{ github.event.inputs.tag }}
                  VERSION=${CURRENT_TAG#v}
                  PREVIOUS_TAG=$(git describe --tags --abbrev=0 $CURRENT_TAG^ 2>/dev/null || echo "")

                  if [ -z "$PREVIOUS_TAG" ]; then
                    CHANGELOG=$(git log --pretty=format:"- %s (%h)" --reverse)
                  else
                    CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..$CURRENT_TAG --reverse)
                  fi

                  echo "# Changelog" > CHANGELOG.md
                  echo "" >> CHANGELOG.md
                  echo "## $CURRENT_TAG" >> CHANGELOG.md
                  echo "" >> CHANGELOG.md
                  echo "$CHANGELOG" >> CHANGELOG.md

                  echo "changelog<<EOF" >> $GITHUB_OUTPUT
                  cat CHANGELOG.md >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Bump version in package.json
              working-directory: ./packages/supplier
              run: |
                  CURRENT_TAG=${{ github.event.inputs.tag }}
                  VERSION=${CURRENT_TAG#v}

                  # Checkout main branch
                  git checkout main

                  # Update package.json version
                  pnpm version $VERSION --no-git-tag-version

            - name: Commit and push version bump
              working-directory: ./packages/supplier
              run: |
                  CURRENT_TAG=${{ github.event.inputs.tag }}
                  VERSION=${CURRENT_TAG#v}

                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"
                  git add package.json
                  git commit -m "chore: bump version to $VERSION [skip ci]"
                  git push origin main

            - name: Create Release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ github.event.inputs.tag }}
                  release_name: Release ${{ github.event.inputs.tag }}
                  body: |
                      ${{ steps.changelog.outputs.changelog }}
                  draft: false
                  prerelease: false

            - name: Cleanup
              run: |
                  echo "Release fixed for ${{ github.event.inputs.tag }}"
                  echo "Version bumped in package.json"
                  echo "GitHub release created"
